name: Code Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false

      # --------------------
      # C / C++
      # --------------------
      - name: Analyze C / C++
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Include *.c,*.cpp -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "No C/C++ files found"
            exit 0
          }

          if (Get-Command clang-tidy -ErrorAction SilentlyContinue) {
            clang-tidy $files.FullName --quiet
          } else {
            Write-Host "clang-tidy not installed"
          }

      # --------------------
      # CMake
      # --------------------
      - name: Analyze CMake
        shell: powershell
        run: |
          if (-not (Test-Path "CMakeLists.txt")) {
            Write-Host "No CMakeLists.txt found"
            exit 0
          }

          if (Get-Command cmakelint -ErrorAction SilentlyContinue) {
            cmakelint CMakeLists.txt
          } else {
            Write-Host "cmakelint not installed"
          }

      # --------------------
      # Dart
      # --------------------
      - name: Analyze Dart
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Include *.dart -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "No Dart files found"
            exit 0
          }

          if (Get-Command dart -ErrorAction SilentlyContinue) {
            dart analyze
          } else {
            Write-Host "Dart SDK not installed"
          }

      # --------------------
      # HTML
      # --------------------
      - name: Analyze HTML
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Include *.html -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "No HTML files found"
            exit 0
          }

          if (Get-Command htmlhint -ErrorAction SilentlyContinue) {
            htmlhint "**/*.html"
          } else {
            Write-Host "htmlhint not installed"
          }

      # --------------------
      # Swift (Windows limit)
      # --------------------
      - name: Detect Swift files
        shell: powershell
        continue-on-error: true
        run: |
          $files = Get-ChildItem -Recurse -Include *.swift -ErrorAction SilentlyContinue
          if ($files) {
            Write-Host "Swift files detected (analysis not supported on Windows)"
          } else {
            Write-Host "No Swift files found"
          }
